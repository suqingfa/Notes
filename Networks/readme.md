
# 物理层

## 数据通信理论基础
傅里叶变换:任何一个正常的周期为T的函数g(t),都可以展开成多个正弦和余弦函数的和    
![](http://latex.codecogs.com/gif.latex?g(t)=\frac{c}{2}+\sum_{n=1}^{\infty}a_n sin(2\pi nft)+\sum_{n=1}^{\infty}b_n cos(2\pi nft))    
基频 f = 1/T    
计算 an bn c    
![](http://latex.codecogs.com/gif.latex?a_n=\frac{2}{T}\int_{0}^{T}g(t)sin(2\pi nft)dt)   
![](http://latex.codecogs.com/gif.latex?b_n=\frac{2}{T}\int_{0}^{T}g(t)cos(2\pi nft)dt)   
![](http://latex.codecogs.com/gif.latex?c=\frac{2}{T}\int_{0}^{T}g(t)dt)   

### 有限带宽的信号
所有传输设施在传输过程中都要损失能量。如果所有的傅里叶分量都等量地衰减，则结果信号将会在振幅上有所减小，但不会变形。
不幸的是，所有的传输设施对于不同的傅里叶分量的衰减并不相同，因此会导致信号变形。通常情况下，在从0-fc这一段范围内，振幅在传输过程中不会衰减。
传输过程中不会明显衰减的这一段频率范围称为**带宽**。
实践中，截止频率并不会那么明显，所以通常引用的带宽是指从0到某一个能保留一半能量的频率处。

### 信道最大数据传输率
尼奎斯特定理:    
最大传输率 = 2H log_2 V (位/秒)    
H 带宽

热噪声的数量可以用信号功率与噪声的比值来衡量，该比值称为**信噪比**。
信号功率S，噪声功率N，则信噪比S/N。通常情况下使用10 lg S/N，该修值称为分贝。

香农结论    
最大传输率 = H log_2 (1 + S/N)

## 公共交换电话网络 PSTN

### 电话系统结构 
完全互连的网络/中心化的网络/层次化结构    
最终电话系统的三个主要的部分：交换局、顾客与交换局之间的线路、交换局之间的长距离连接。    

端局：本地中心局    
本地回路：用户的电话机与端局之间的连线    
长途局：每个端局都有一个或多个连接着的交换中心，这些交换中心称为长途局。如果它们在同一个局部地区的话，称为汇接局    
长途连接干线：端局与长途局之间的连线

电话系统由三个主要部件构成
- 本地回路 (模拟信号)
- 干线 (数字信号)
- 交换局

多路复用：对于长途干线，主要的问题是如果 将多个呼叫连接收集起来，并且通过同一条光纤将它们发送出去。

### 本地回路 调制解调器 ADSL 无线
调制解调器：当一台计算机希望通过模拟信号线路发送数字数据时，这些数据首先必须转换成模拟信号，才能通过本地回路进行传输。完成这一过程的设备称为调制解调器。    
传输线路存在的三个主要问题：衰减、延迟畸变和噪声。    
衰减是信号在往外传输的过程中能量的损失。这种损失可以表示为每分量多少分贝。能量损失的数量跟频率有关。    
不同的傅里叶分量在线路上的传播速度不同，这种速度的差异会导致接收端信号的畸变。    
噪声是来自非发射器的多余能量。热噪声、串音、脉冲噪声。

#### 调制解调器
AC信号传输。    
首先引用1000-20000Hz内的一个连续波，称为为**正弦载波**。它的振幅、频率或相位被调制后可用来传输信息。
- 调幅
- 调频
- 相位调制

尼奎斯特定理表明，对于理想状态下3000Hz传输线路，采样率超过6000Hz是没有意义的。因此大多数调制解调器采样率为2400Hz，它们的焦点集中在每次采样如何表达更多位信息。    
波特：每秒采样的次数用波特来计量。    
在一个波特中，发送一个码元。在2400波特的线路中，如果码元用0V表示0，1V表示1，则位传输率为2400bps。
然而如果0，1，2，3伏电压都使用的话，每个码元可以包含2位，因此传输速率为4800bps。

#### 数字用户线路 Digital Subscriber Lines
宽带：如果一项服务所提供的带宽比标准的电话服务还要多的话，有时候这样的服务称为宽带。
ADSL 非对称数字线路

调制解调器之所以慢是因为每条本地回路都在端局那里被终止，在这个终止的点上，有一个滤波器把所有300Hz以下3400Hz以上的频率减弱了。    
使用xDSL时，当一名顾客预订了服务时，进来的线路被连接到另一种交换机上，并且这种交换机没有滤波器，因而可以充分发挥本地回路的全部承载能力。

### 干线和多路复用
- 频分多路复用
- 波分多路复用
- 时分多路复用

### 交换
- 电路交换
- 报文交换 
当发送方有一块数据要发送时，它被存储在相一个交换局，然后再转发出去。对数据大小没有限制。交换机必须使用硬盘来缓存大块数据。
- 分组交换
分组交换网络对数据的大小有一个严格的限制，使得这些数据可以被缓存在内存中。分组交换使用存储-转发通信机制。

# 数据链路层 frame
两台相邻机器之间实现可靠有效的通信。
数据链路层要完成的功能：
- 向网络层提供定义良好的服务接口
- 处理传输错误
- 调节数据流，确保慢速的接收方不会被快速的发送发淹没

## 成帧
物理层的任务是接收原始的位流，并试图将它递交给目标机器。这个位流并不保证没有错误。检测错误和纠正错误的工作由数据链路层完成。
对于数据链路层，一般的做法是将位流分解 成离散的帧，并计算第一帧的校验和。

将原始位流分解到离散的帧中
- 字符计数法
利用头部中的一个域来指定该帧中的字符数。计数值可能因为传输错误而被弄乱。

- 含字节填充的分界符法
让每一帧都用一些特殊的字节来作为开始和结束。标志字节。
字节填充：当标志字节出现在数据中时，发送方的数据链路层在这种情况下在标志字节前插入特殊的转义字节。

- 含位填充的分界符法
每个帧的开始和结束都有一个特殊的位模式 01111110。当发送方数据链路层碰到数据中5个连续的位1时，它自动在输出位流中填充一个位0。

- 物理层编码违倒法

## 错误检测和纠正
两种基本的用于错误处理的过程
- 纠错码 在每个被发送的数据中包含足够的冗余信息，以便接收方可以推断出被发送的数据。
- 检错码 在每个被发关的数据中包含一些冗余信息，但这些信息只能让接收方推断出发生了错误。

### 检错码
奇偶位    
CRC 循环冗余校验码

## 基本数据链路层协议
ARQ 自动重传请求协议

## 滑动窗口协议
捎带确认：将确认暂时延迟以便可以钩到一个外发数据帧    
滑动窗口协议    
在任何时刻，发送发总是维持着一组序列号，分别对应于允许它发送的帧。称这些帧落在发送窗口内。     
类似的，接收方也维持着一个接收窗口，对应于一级允许它接受的帧。

1位滑动窗口协议

回退n帧技术的协议
接收到错误帧时，接收方丢弃所有后续帧

选择性重传的协议
接收到坏帧被丢弃，坏帧后续的好帧缓存着。否定确定NAK

## Internet 中的数据链路层

### HDLC 高级数据链路控制

### PPP Point-to-Point Protocol 点到点协议
PPP 提供了三类功能
- 成帧方法
- 链路控制协议。可用于启动线路、测试线路、协商参数，以及当线路不再需要的时候可以温和地关闭线路。LCP(Link Control Protocol)
- 协商网络层选项的方法。NCP(Network Control Protocol)
''

# 介质访问控制子层
网络可以分成两大类，使用点到点连接的网络和使用广播信道的网络。本章将讨论广播网络和相应协议。    
在任何广播网络中，关键的问题是：当存在多方面要竞争使用信道的时候，如何确定谁可以使用信道。广播信道有时也称为多路访问信道。    
用于控制多路访问信道上确定下一个使用者的协议属于数据链路层的一个子层，称为 **MAC(Medium Access Control 介质访问控制)子层**。

## 信道分配
一般分为静态方案和动态方案

### 静态方案
FDM 频分多路复用 如果有N个用户，则整个带宽分成N等份，第个用户分配一份。只有当用户数量比较少而且固定不变，并且每个用户都有繁重的流量负担的时候FDM才是一种有效的分配机制。

### 动态方案
假设基础：
- 站模型 Station Model 该模型由N个独立的站组成，每个站有一个程序或用户产生供传输用的帧。这里的站有时也称为终端 terminal。
- 单信道假设 对于所有的通信都只有一个信道可以使用。所有的站都可以在该信道上传输数据，也可以从该信道上接收数据。
- 冲突假设 如果两帧同时被传输，则它们在时间上会有重叠，这样得到的信号是混乱的，这种情况称为冲突。所有的站都能检测冲突事件。冲突的帧必须在以后再次被发送。
- 连续时间 有任何时刻都可以开始传输帧，不需要通过一个主时钟将时间分成离散的间隔。
- 分槽时间 时间被分成离散的间隔。帧的传输总是从某一个槽的起点开始发送。一个时间槽可能包含0、1或多个帧，分别对应于空闲，一次成功的发送，或一次冲突。
- 载波检测 一个站在使用信道前，它可以辨别该信道当前是否正在被使用。
- 无载波检测 在使用信道前，站无法检测信道。它们只是盲目开始传输，以后再判断这次传输是否成功。

## 多路访问协议

### ALOHA
纯ALOHA 当用户有数据传输时就让它们传输。可能会有冲突，冲突的帧将被损坏。发送方只要通过监听信道，总是可以知道它的帧是否被损坏。
如果无法在传输的时候进行监听，则确认就很有必要。如果发送的帧被损坏，则发送方只要等待一段随机时间，然后再次发送该帧。

分槽ALOHA 必须要等到下一个时间槽才可以发送。

### 载波检测多路访问协议
如果一个协议中，每个站都监听是否存在载波(是否有传输)，并采取相应的动作，则这样的协议称为 载波检测协议(carrier sense protocol)

#### 持续和非持续的 CSMA Carrier Sense Multiple Access    

1-持续CSMA 当一个站有数据要发送时，它首先监听信道，看当时是否有其他的站正在传输。如果信道忙，该站会等待直到信道空闲。
当该站检测到信道空闲的时候，它就发送一帧数据。如果冲突发生，该站等待一段随机时间，然后再次检测和发送。

非持续CSMA 一个站在发送数据之前，先检测信道。如果没有人在发送，则该站自己开始发送数据。如果信道正在使用中，则该站并不持续监听。
相反，它会等待一段随机时间后，再进行同样的算法。 会有更好的信道利用率，但导致更长的延迟。

p-持续CSMA 应用于分槽的信道。当一个站准备发送数据时，它会检测信道。如果信道是空闲的，它按照概率p的可能性发送数据。

#### 带冲突检测的CSMA  CSMA/CD
一旦传输过程中检测到冲突之后，它们应该立即停止传送数据。 广泛应用于LAN中的MAC子层。

检测到冲突的最小时间是将信号从一个站传送到另一个站所需要的时间。

### 波分多路访问协议 WDMA
为了允许同一时刻有多个站进行传输，波谱被分成多个信道。每个站分配两个信道，一个窄的信道用作控制信道，通过综可以向每人个站发送通知消息。
一个宽的信道用作数据通信。

### 无线LAN协议
避免冲突的多路访问 MACA Multiple Access with Collision Avoidance 发送方刺激一下接收方，让它传输出一个短帧，因此接收方附近的站可以检测到该帧，从而在接下来的数据帧传输过程中它们不再发送数据。

MACAW MACA for Wireless 

## 以太网
802.3 以太网  802.11 无线LAN    
802.3 和 802.11 有不同的物理层也有不同的MAC子层，有共同的逻辑链路控制子层。   
以太 电缆

**集线器** 在两个方向上接收放大和重传信号。

### 曼彻斯编码 Manchester encoding
让接收方在没有外部时钟参考的情况下，可以毫歧义地确定第一位的起始、结束或者中间位置。有两种这样的方法，曼彻斯编码 和 差分曼彻斯编码

曼彻斯编码 每一位的周期被分成两个相等的间隔。二进制的 1 在发送时，第一个间隔中为高电位，第二个间隔中为低电位。二进制 0 相反。
缺点 要求带宽是二进制编码的两倍，因为脉冲是位宽度的一半。

差分曼彻斯编码 如果在间隔的起始处没有相变，则表示 1；如果在间隔的起始处出现相变，则表示 0。
差分曼彻斯编码需要更加复杂的设备，但是提供了更好的抗噪声能力。

由于曼彻斯编码方案比较简单，所以所有的以太网系统都使用这种编码方案。高信号+0.85V，低信号-0.85V，直流0V。

### 以太网MAC子层协议
第一帧包含一个8字节的前导域，该域包含位模式10101010，这个位模式经过曼彻斯特编码后，方便时钟同步。

帧格式
字节       |  8   |    6   |   6  |  2 | 1-1500 | 0-46 |  4   |    
DIX以太网  |先导域|目标地址|源地址|类型|  数据  | 填充 |校验和|    
IEEE 802.3 |先导域|目标地址|源地址|长度|  数据  | 填充 |校验和|    
长度/类型 当值小于1500时为长度，当值大于1500时为类型

以太网最小帧 64字节。限制最小帧长的理由：当一个短帧还没有到达电缆的远端时发送站已经完成了该帧的传送，而在电缆的远端处，该帧可能与另一帧冲突。
对于2500米，往返一周时间大约50us，10Mbps的情况下，一位需要100ns，所以500位保证可以工作的最小帧。考虑到加上一点安全余量，该数字被增加到512位，即64字节。

### 二元指数后退算法
冲突发生时，如何确定随机等待的时间。
一般地，在第i次冲突发生后，在0 - 2^i-1之间随机选择一个数，然后等待这么多个时槽。到达10次冲突后，随机固定在最大值1023。这个算法称为二元指数退后算法。

### 交换式以太网
交换机 每个输入帧都被缓存在地块插入卡上，然后，如果有必要，这些帧被通过一块高速底板从源卡传递到目标卡。

### 逻辑链路控制 LLC
通过提供一种统一的格式，以向网络层提供一个接口，从而隐藏各种802网络之间的差异。
LLC位于MAC层上，上层网络把一个分组传递给LLC，LLC增加一个LLC头，其中包含了序列号和确认号，然后将结果插入802帧的净荷域中，并发送出去。
LLC提供三种服务选择 不可靠的数据报服务，有确认的数据报服务，面向连接的可靠服务。
LLC头包含三个域：目标访问点，源访问点，控制域

# 网络层
网络层关注的是如何将分组从源端沿着网络路径送达目标端。

## 网络层设计要点
- 存储转发分组交换机制
- 向传输层提供服务
    - 所提供的服务应该独立于路由器
    - 路由器的数量、类型和拓扑关系对于传输层来说应该是不可见的
    - 传输层可以使用的网络地址应该有一种统一的编址方式，甚至可以跨越多个LAN和WAN
- 无连接服务的实现
- 面向连接服务的实现

## 路由算法
路由算法是网络层软件的一部分，它负责确定一个进来的分组应该被传送到哪一条输出路线上。    
对路由(确定该使用哪一条路径)和转发(当一个分组到达时所采取的动作)进行区分有时候是非常有用的。
转发即在每个分组到达的时候对它进行处理，它在路由表中查找该分组所对应的输出线路。
负责填充和更新路由表的，正是路由算法起作用的地方。

路由算法可分两大类，非自适应和自适应。
- 非自适应算法不会根据当前测量或估计的流量和拓扑结构来调整它们的路由决策。这个过程也称为静态路由
- 自适应算法会改变它们的路由决策，以反映拜年结构的变化，通常也反映出流量的变化情况。

### 优化原则 
最优化原则 如果路由器J是在从路由器I到路由器K的最优路径上，那么从J到K的最优路径必定也沿着同样的路径。
最优化原则的结果是，从所有的源到一个指定的目标的最优路径的集合构成一颗以目标节点为根的树。这样的树称为汇集树。

### 扩散法
每一个进来的分组将被发送到除了它进来的线路之外的每一条线路上。
除非采取某种办法来抑制分扩散过程，否则扩散将会产生无限多的分组。
一种办法是在每个分组的头中包含一个跳计数器，经过每一跳之后该计数减一，当计数器到达0的时候该分组被丢弃。
另一种技术是记录下哪些分组已经被扩散过了，从而避免再次发送这些分组。

一个稍实际一点的扩散法变种是选择性扩散。

### 距离矢量路由
每个路由器维护着一张表，表中列出当前已知的到每个目标的最佳距离，以及所使用的线路。通过在邻居之间相互交换信息，路由器不断地更新它们的内部表。

对于好的消息反应非常快，对于坏消息反应非常迟缓。无穷计算，即距离矢量路由算法需要很长的时间才能收敛到稳定的状态。

### 链路状态路由
每个路由器必须完成以下工作
- 发现它的邻居，并知道其网络地址
- 测量到各邻居节点的延迟或开销
- 构造一个分组，分组中包含所有它刚刚知道的消息
- 将这些分组发送给所有其他的路由器
- 计算出到每一个其他路由器的最短路径

创建链路状态分组    
一旦所需要的交换信息已经收集到了，每个路由器的下一步工作是建立一个包含所有这些数据的分组。
该分组的内容首先是发送方的标识 ，接着是一个序列号和年龄，以及一个邻居列表。对于每个邻居，同时也要给出到这个邻居的延迟。


发布链路状态分组    
基本的思路是使用扩散法来发布链路状态分组。为了控制扩散过程，每一个分组都包含一个序列号，序列号随着每一个新的分组而递增。
当一个新的链路状态分组进来的时候，路由器在已经看到的分组列表中检查 这个新进来的分组。如果 它是新的，那么除了它到来的 那条线路之外，在其他的线路上全部轩发该分组。
如果 它是一个重复分组，则将它生育。如果一个分组的序列号小于当前 所看到过的来自该源路由器的最大序列号，则它将被当作过时的分组而拒绝。    
这个自闭还有一些问题。    
- 第一，如果序列回转(达到了最大的整数值之后 再加1又回到最小值)，刚可能 产生混淆。解决方案是使用一个32位的序列号。即使每秒产生一个分组，也需要137年才可能 发生回转。
- 第二 如果一个路由器崩溃了，那么它将丢失所有的序列号记录。如果它再从0开始，那么下一个分组将被作为重复分组而拒绝。
- 第三 如果一个序列号被破坏，比如发送方发送的序列号为4，但是产生了一位错误，所以接收方看到的序列号是65540，那么序列号从5-65540的分组都将当作过时分组而拒绝    
所有这些问题的解决方案是在每个分组的序列号之后包含年龄信息，并且每秒将年龄减1。当年龄到0的时候，来自该路由器的信息被丢弃。

### 分级路由
在采用了分组路由之后，路由器被分成区域，每个路由器知道如何将分组路由到自己所在区域的目标地址，但是对于其他区域的内部结构毫不知情。

### 广播路由
同时给所有的目标发送一个分组，称为广播。

一种不要求子网具有任何特殊性的广播方法是，让源机器简单的给每一个目标单独发送一个分组。
扩散是另一种很显然的候选方法。
第三种算法是多目标路由。
第四种广播算法电焊工的使用了以发起广播的路由器为根的汇集树
最后一种广播算法 逆向路径转发。当一个广播分组到达一个路由器的时候，该路由器对它进行检查，看它到来的那条线路是否通过用来给给广播发送伊比有的那条线路。

### 多播路由
给一个组发送消息称为多播。

## 拥塞控制算法
当一个子网或者子网的一部分中出现了太多分组的时候，网络的性能开始下降。这种情况称为拥塞。

拥塞控制与流控制
拥塞控制的任务是确保子网能够承载所到达的流量。
流控制只与特定的发送方和特定的接收方之间的点到点流量有关。它的任务是确保一个快速的发送方不会持续的以超过接收方接收能力的速率传输数据。

### 拥塞控制的通用原则
开环的解决方案试图用良好的设计来解决问题，它的本质是从一开始就保证问题不会发生。
完成开环控制的手段有：确定何时接受新的流量，确定何时丢弃分组及丢弃哪些分组，在网络的不同点上执行高度决策。
所有这些手段的共同点是，它们在做出决策的时候不考虑网络的当前状态。

闭环方案则建立在反馈一路的概念基础之上，当这种方法用于拥塞控制的时候，它有三个部分
- 监视系统，检测到何时何地发生了拥塞
- 将该信息传递到能够采取行动的地方
- 调整系统的运行，以改正问题
闭环算法又进一步分成两类，显式反馈和隐式反馈。
在显式反馈中，从拥塞点向源端发送分组以警告源端。在隐式反馈算法中，源端利用本地观察到的现象来推断是否存在拥塞

一旦出现拥塞，可以用两种解决方案：增加资源，降低负载。

### 拥塞预防策略

### 虚电路子网中的拥塞控制
一种广泛应用的，防止已经拥塞子网进一步恶化的技术是 准入控制。其思想是，一旦出现拥塞的信号，则不再创建任何虚电路，直到问题排除为止。
另一种方法是允许建立新的虚电路，但是谨慎地选择路由，使所有新虚电路都绕开有问题的区域。

### 数据报子网中的拥塞控制
- 警告位
- 抑制分组
- 逐跳抑制

### 负载丢弃
当路由器因为来不及处理分组而被淹没的时候，只要将这些分组丢弃。优先丢弃新的分组的策略称为葡萄酒策略。优先丢弃旧的分组的策略称为牛奶策略。

#### 随机的早期检测 RED Random Early Detection
在实际耗尽所有的缓存空间之前就开始丢弃分组。
告知主机有关的问题，一种是给源发送一个抑制分组。一种是将选取出来的分组丢弃，而不向源主机报告。

### 抖动控制
分组到达时间的变化量被称为抖动

## 服务质量 QoS Quality of Service
可靠性延迟抖动带宽

### 获得更好服务质量所使用的技术
- 过度提供资源
- 缓冲能力 将数据缓存起来并不会影响到可靠性和带宽，但会增加延迟，可以消除抖动
- 流量整形 调节数据传输的平均速率(突发性)
- 漏涌算法 一个常数服务时间的单服务器排队系统
- 令牌桶 漏桶算法不允许空间的主机将许可权保存起来以便以后发关大的突发数据，令牌桶算法则允许将许可权保存起来，直到到达桶的最大尺寸。
- 资源预留
- 准入控制

## 网络互联
有许多不同网络存在包括LAN，WAN。而且每一层上，有大量的协议在广泛使用。能够处理多种协议的路由器称为多协议路由器。

## Internet上的网络层
原则
- 保证它能够工作
- 尽可能使它简单
- 作出明确的选择
- 尽可能做到模块化
- 期望具备异构性
- 避免使用固定不变的选择和参数
- 寻找一个好护彤地，它不必是最完美的。
- 对于发送操作一定要严格，而对于接收操作要有一定的容忍度
- 考虑伸缩性
- 考虑性能和代价

IP的任务 尽力投递

### IPv4
| 4  | 4 |    8    |        16        |    
|版本|IHL|服务类型||      总长度      |    
|      标识        ||DF|MF|  分段偏移 |    
|  TTL   |  协议   |    头部校验和    |    
|              源地址                 |    
|             目的地址                |    
|               选项                  |    
|               数据                  |    

- IHL 头部长 指明头部有多长(32位长度为单独) 最小值5，最大值15。因此最小头部大小20字节，最大60字节
- 服务类型 Type of Service 区分不同的服务类型，可靠性和速度
- 总长度 Total Length 该数据报中所有的内容，即头部和数据
- 标识 Identification 让目标主机确定一个新到达的分段属于哪一个数据报
- DF 不分段 Don't Fragment
- MF 更多的分段 More Fragment
- 分段偏移 Fragment offset 
- TTL 限制分组生存期计数器。在每一跳该计数器减一，当它减至0时，分组被丢弃。
- 协议 Protocol 指明传输层协议
- 头部核验和 Header checksum

### IP 地址
IP地址包含网络号和主机号
32位的网络地址通常写作点分十进制标记法


分类编址方案
类别 前缀 网络号位数 主机号位数
A类  0    7          24
B类  10   14         16
C类  110  25         8
D类  1110 多播地址
E类  11110 保留

子网
从主机号拿出一些位构成子网号

CIDR 无类别域间路由
将IP地址以可变大小块的方式进行分配，而不管它们所属的类别。
路由表由网络的三元组(IP 子网掩码 输出线路)构成。当一个分组到达的时候，路由器首先将它的目标地址提取出来，然后对路由器表项扫描，用掩码去与目标地址，
再将它与表项中的网络号进行比较，看两者是否匹配。有可能找到多个匹配项，使用掩码长度最长的表项。

NAT 网络地址转换
为组织分配一个或多个IP地址。在组织内部，每台计算机都有惟一的IP地址，它使用该地址来传输内部流量。当一个分组离开组织网络时，需要执行一个地下转换。

### Internet 控制协议
在Internet的网络层，除了IP用于数据传输以外，还有一些协议包括ICMP ARP RARP BOOTP和DHCP

ICMP Internet Control Message Protocol 控制消息协议
当意外情况发生时，ICMP 可以报告有关的事件。

ARP Address Resolution Protocol 地址解析协议

# 传输层 segment
在源机器和目标机器之间提供可靠的，性价比合理的数据传输功能，并且与当前所使用物理网络完全独立。

传输层有两个主要的协议 无连接的UDP 面向连接的TCP

## UDP User Datagram Protocol 用户数据报协议
采用UDP而不是原始的IP，最主要的价值是增加了源端口和目标端口。如果没有端口域，则传输层将不知道如何处理该分组。

UDP报文头   
|   16  |   16    |    
|源端口 | 目标端口|    
|UDP长度|UDP校验和|    

应用 实时传输协议 FTP Real-time Transport Protocol 

## TCP Transmission Control Protocol 传输控制协议
为在不可靠的网络中提供一个可靠的端到端字节流而设计。所有的TCP都是双全工的，并且是点到点的。TCP连接是字节流。

TCP的一个关键特征是连接上的每个字节都有自己的唯一的32位序列号。

TCP报文头
|                               32位                         |    
|          源端口               |          目标端口          |    
|                         序列号                             |    
|                         确认号                             |    
|头长度||URG|ACK|PSH|RST|SYN|FIN|          窗口大小          |
|          校验和               |          紧急指针          |    
|                         可选项                             |

TCP中的流控制是通过一个可变大小的滑动窗口来完成的。Window Size 窗口大小域指定了从被确认的字节算起可以发送多少个字节。

UDP/TCP的校验和范围包括头部、数据和伪头部
伪头部    
|            32位                |    
|          源地址                |    
|         目的地址               |    
|00000000|协议|    数据段长度    |

TCP连接建立 三次握手

TCP连接释放 单向释放 两个FIN 两个ACK

### TCP传输策略
Nagle算法 当数据以每次一个字节的方式进入到发送方的时候，发送方只是发送一个字节，然后将其余字节缓冲搞起来，直到送出去的建队上字节被确认。

愚笨窗口综合症 当数据以大块的形式被传递给发送端TCP实体，但接收端的交互应用每次只读取一个字节数据的时候，就会发生。
Clark算法 禁止接收方只发送1字节的窗口更新数据段。

Nagle算法和Clark算法是相互补充的。
Nagle试图解决发送端应用每次向TCP传递一个字节而引起的问题。
Clark试图解决由于接收端应用每次从TCP流中读取一个字节而引起的问题。

### TCP拥塞控制
Internet上的大多数传输超时都是由于拥塞而引起的。

每个发送方维护两个窗口：第一个是接收方准许的窗口(接收方容量)，第二个是拥塞窗口(网络容量)。最终发送的字节数量是两个窗口的最小值。

当一个连接被建立的时候，发送方将拥塞窗口初始化为该连接上当前使用的最大数据长度。

慢启动算法 拥塞窗口以指数增加，直到发生超时或达到接收窗口大小。

Internet的拥塞控制，除了接收方窗口大小和拥塞窗口外，还使用了 阈值，初始时为64KB。
当一次超时发生的时候，阈值被设置为当前拥塞窗口的一半，而拥塞窗口被重置为一个最大数据段。
然后使用慢启动算法来决定网络的处理能力，不过当增长到阈值的时候便使用线性增长。

# 应用层 message

## HTTP
HTTP 可以采用 持续连接 或 非持续连接

### 请求报文
请求行 方法 URL HTTP版本\r\n    
多个首部行 首部字段名: 值\r\n    
\r\n    
主体

### 响应报文
状态行 版本 状态码 状态信息\r\n    
多个首部行 首部字段名: 值\r\n    
\r\n    
实体

### cookie
cookie 有4个组件
- HTTP响应报文中的Set-cookie首部行
- HTTP请求报文中的cookie首部行
- 在用户端系统中保留的cookie文件，并由用户浏览器进行管理
- 位于Web站点的一个后台端数据库

### Web缓存 代理服务器
- 浏览器建立一个到Web缓存器的TCP连接，并向Web缓存器发送一个HTTP请求
- Web缓存器进行检查，看本地是否存储了该对象副本。如果有，就向客户浏览器用HTTP响应报文返回该对象
- 如果Web缓存器中没有该对象，它就打开一个与初始服务器的TCP连接。Web缓存器通过TCP连接向初始服务器发送一个HTTP请求。收到请求后，初始服务器向缓存器发送响应。
- Web缓存器收到该对象时，它在本地存储了一份副本，并向客户发送该副本。

## FTP
FTP使用了两个并行的连接来传输文件，一个是控制连接，一个是数据连接。
控制连接用于在两主机之间传输控制信息，如用户标识、口令、改变远程目录命令、存放(PUT)和获取(GET)文件命令。
数据连接用于实际发送一个文件。控制连接贯穿了整个用户会话期间，但是会话中的每一次文件传输都需要建立一个新的数据连接。
FTP服务器必须在整个会话期间保留用户的状态。

### 命令与响应
每个命令由4个大写字母组成，有些还有可选参数。每个命令后跟回车换行符。
- USER username 用于向服务器传送用户标识
- PASS password 用于向服务器发送口令
- LIST 用于请求服务器当前远程目录的所有文件列表。文件列表是经数据连接传送的，不是控制连接中传送的。
- RETR filename 用于从远程主机当前目录检索(GET)文件。该命令引起远程主机发起一个数据连接，并由该数据连接发送所请求的文件。
- STOR filename 用于在远程主机的当前目录上存放(PUT)一个文件

响应是一个3位的数字，后跟一个可选的信息
- 331 Username OK, Password required(用户名OK，需要口令)
- 125 Data connection already open;transfer starting
- 425 Can't open data connection
- 452 Error writing file

## Email
Email由3个主要组成部分:用户代理，邮件服务器和简单邮件传输协议SMTP。
- 用户代理允许用户阅读、回复、转发、保存和撰写报文。Outlook和Apple Mail就是电子邮件用户代理的例子。
- 完成邮件的撰写后，用户代理向邮件服务器发送邮件，此时邮件放在邮件服务器的外出报文队列中。
- 每个接收方(用户)在其中的某个邮件服务器上有一个邮箱。用户的邮箱管理和维护着发送给他的报文。

典型的邮件发送过程：从发送方的用户代理开始，传输到发送方的邮件服务器，再传输到接收方的邮件服务器，然后在这里再分发到接收方的邮件中。
如果发送方的服务器不能将邮件交付给接收方的服务器，发送方的邮件服务器在一个报文队列中保持该报文将在以后尝试再次发送。

### SMTP
SMTP是因特网电子邮件中主要的协议。它使用TCP数据传输服务，从发送方的邮件服务器向接收方的邮件服务器发送邮件。
每台邮件服务器即运行着SMTP客户端，也运行着SMTP服务器端。

### POP3 IMAP HTTP
邮件访问协议

通信流程    
A的用户代理 -> SMTP -> A的邮件服务器 -> SMTP -> B的邮件服务器 -> POP3/IMAP/HTTP -> B的用户代理

## DNS
DNS是
- 一个由分层的DNS服务器实现的分布式数据库
- 一个使得主机能够查询分布式数据库的应用层协议
